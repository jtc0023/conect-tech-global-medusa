{
  "$schema": "https://schema.railpack.com",
  "provider": "node",
  "packages": {
    "node": "20"
  },
  "caches": {
    "yarn": {
      "directory": "/root/.yarn",
      "type": "shared"
    },
    "node-modules": {
      "directory": "/app/node_modules",
      "type": "shared"
    }
  },
  "steps": {
    "install": {
      "inputs": [
        {
          "local": true,
          "include": ["package.json", "yarn.lock", ".yarnrc.yml"]
        }
      ],
      "commands": [
        { "cmd": "yarn install --frozen-lockfile", "customName": "Install dependencies" }
      ],
      "caches": ["yarn", "node-modules"]
    },
    "build": {
      "inputs": [
        { "step": "install" },
        {
          "local": true,
          "include": ["."],
          "exclude": ["node_modules", ".env*", "static"]
        }
      ],
      "commands": [
        { "cmd": "yarn build", "customName": "Build Medusa backend" }
      ]
    }
  },
  "secrets": [
    "DATABASE_URL",
    "REDIS_URL",
    "JWT_SECRET",
    "COOKIE_SECRET",
    "STORE_CORS",
    "ADMIN_CORS",
    "AUTH_CORS"
  ],
  "deploy": {
    "base": {
      "image": "node:20-alpine"
    },
    "inputs": [
      {
        "step": "build",
        "include": [
          "dist",
          "package.json",
          "yarn.lock",
          "medusa-config.ts",
          "static"
        ]
      },
      {
        "step": "install",
        "include": ["node_modules"]
      }
    ],
    "startCommand": "yarn predeploy && yarn start"
  }
}