{
  "$schema": "https://schema.railpack.com",
  "provider": "node",
  "packages": {
    "node": "20"
  },
  "caches": {
    "yarn": {
      "directory": "/root/.yarn",
      "type": "shared"
    },
    "node-modules": {
      "directory": "/app/node_modules",
      "type": "shared"
    }
  },
  "steps": {
    "install": {
      "commands": [
        { "src": "package.json", "dest": "package.json" },
        { "src": "yarn.lock", "dest": "yarn.lock" },
        { "src": ".yarnrc.yml", "dest": ".yarnrc.yml" },
        { "cmd": "yarn config set nodeLinker node-modules", "customName": "Configure Yarn to use node_modules" },
        { "cmd": "yarn config set enableGlobalCache false", "customName": "Disable global cache" },
        { "cmd": "yarn install --check-cache", "customName": "Install dependencies" }
      ],
      "caches": ["yarn", "node-modules"]
    },
    "build": {
      "inputs": [
        { "step": "install" }
      ],
      "commands": [
        { "src": ".", "dest": ".", "exclude": ["node_modules", ".env*", "static", "yarn.lock"] },
        { "cmd": "yarn build", "customName": "Build Medusa backend" }
      ]
    }
  },
  "secrets": [
    "DATABASE_URL",
    "REDIS_URL",
    "JWT_SECRET",
    "COOKIE_SECRET",
    "STORE_CORS",
    "ADMIN_CORS",
    "AUTH_CORS",
    "MEDUSA_WORKER_MODE",
    "DISABLE_MEDUSA_ADMIN",
    "LOCKING_REDIS_URL"
  ],
  "deploy": {
    "base": {
      "image": "node:20-alpine"
    },
    "inputs": [
      {
        "step": "build",
        "include": [
          "dist",
          "package.json",
          "medusa-config.ts",
          "static"
        ]
      },
      {
        "step": "install",
        "include": ["node_modules"]
      }
    ],
    "startCommand": "yarn predeploy && yarn start"
  }
}